<template>
  <ms-container>
    <ms-main-container>
      <el-card class="table-card" v-loading="result.loading">
        <template v-slot:header>
          <ms-table-header :is-tester-permission="true" :condition.sync="condition" @search="search" @create="create"
                           :create-tip="btnTips" :title="title"/>
        </template>
        <el-table @row-click="link" :data="items" style="width: 100%" @sort-change="sort">
          <el-table-column prop="name" :label="$t('commons.name')"/>
          <el-table-column prop="description" :label="$t('commons.description')"/>
          <!--<el-table-column prop="workspaceName" :label="$t('project.owning_workspace')"/>-->
          <el-table-column
            sortable
            prop="createTime"
            :label="$t('commons.create_time')"
            show-overflow-tooltip>
            <template v-slot:default="scope">
              <span>{{ scope.row.createTime | timestampFormatDate }}</span>
            </template>
          </el-table-column>
          <el-table-column
            sortable
            prop="updateTime"
            :label="$t('commons.update_time')"
            show-overflow-tooltip>
            <template v-slot:default="scope">
              <span>{{ scope.row.updateTime | timestampFormatDate }}</span>
            </template>
          </el-table-column>
          <el-table-column :label="$t('commons.operating')">
            <template v-slot:default="scope">
              <ms-table-operator :is-tester-permission="true" @editClick="edit(scope.row)" @deleteClick="del(scope.row)"/>
            </template>
          </el-table-column>
        </el-table>
        <ms-table-pagination :change="list" :current-page.sync="currentPage" :page-size.sync="pageSize"
                             :total="total"/>
      </el-card>
    </ms-main-container>

    <el-dialog :title="title" :visible.sync="createVisible">
      <el-form :model="form" :rules="rules" ref="form" label-position="right" label-width="100px" size="small">
        <el-form-item :label="$t('commons.name')" prop="name">
          <el-input v-model="form.name" autocomplete="off"></el-input>
        </el-form-item>
        <el-form-item :label="$t('commons.description')" prop="description">
          <el-input type="textarea" v-model="form.description"></el-input>
        </el-form-item>
      </el-form>
      <template v-slot:footer>
        <div class="dialog-footer">
          <ms-dialog-footer
            @cancel="createVisible = false"
            @confirm="submit('form')"/>
        </div>
      </template>
    </el-dialog>

  </ms-container>
</template>

<script>
  import MsCreateBox from "../settings/CreateBox";
  import {Message} from "element-ui";
  import MsTablePagination from "../common/pagination/TablePagination";
  import MsTableHeader from "../common/components/MsTableHeader";
  import MsTableOperator from "../common/components/MsTableOperator";
  import MsDialogFooter from "../common/components/MsDialogFooter";
  import {_sort, getCurrentUser} from "../../../common/js/utils";
  import MsContainer from "../common/components/MsContainer";
  import MsMainContainer from "../common/components/MsMainContainer";

  export default {
    name: "MsProject",
    components: {
      MsMainContainer,
      MsContainer, MsTableOperator, MsCreateBox, MsTablePagination, MsTableHeader, MsDialogFooter},
    data() {
      return {
        createVisible: false,
        result: {},
        btnTips: this.$t('project.create'),
        title: this.$t('project.create'),
        condition: {},
        items: [],
        form: {},
        currentPage: 1,
        pageSize: 5,
        total: 0,
        rules: {
          name: [
            {required: true, message: this.$t('project.input_name'), trigger: 'blur'},
            {min: 2, max: 25, message: this.$t('commons.input_limit', [2, 25]), trigger: 'blur'},
            {
              required: true,
              pattern: /^(?!-)(?!.*?-$)[a-zA-Z0-9\u4e00-\u9fa5-]+$/,
              message: this.$t('project.special_characters_are_not_supported'),
              trigger: 'blur'
            }
          ],
          description: [
            {max: 50, message: this.$t('commons.input_limit', [0, 50]), trigger: 'blur'}
          ],
        },
      }
    },
    props: {
      baseUrl: {
        type: String
      }
    },
    mounted() {
      if (this.$route.path.split('/')[2] === 'project' &&
        this.$route.path.split('/')[3] === 'create') {
        this.create();
        this.$router.push('/' + this.baseUrl + '/project/all');
      }
      this.list();
    },
    watch: {
      '$route'(to) {
        if (this.$route.path.split('/')[2] === 'project' &&
          to.path.split('/')[3] === 'create') {
          this.create();
          this.$router.push('/' + this.baseUrl + '/project/all');
        }
      }
    },
    computed: {
      currentUser: () => {
        return getCurrentUser();
      }
    },
    destroyed() {
      this.createVisible = false;
    },
    methods: {
      create() {
        let workspaceId = this.currentUser.lastWorkspaceId;
        if (!workspaceId) {
          this.$warning(this.$t('project.please_choose_workspace'));
          return false;
        }
        this.title = this.$t('project.create');
        this.createVisible = true;
        this.form = {};
      },
      edit(row) {
        this.title = this.$t('project.edit');
        this.createVisible = true;
        this.form = Object.assign({}, row);
      },
      submit(formName) {
        this.$refs[formName].validate((valid) => {
          if (valid) {
            let saveType = "add";
            if (this.form.id) {
              saveType = "update"
            }
            this.result = this.$post("/project/" + saveType, this.form, () => {
              this.createVisible = false;
              this.list();
              Message.success(this.$t('commons.save_success'));
            });
          } else {
            return false;
          }
        });
      },
      del(row) {
        this.getRelatedResource(row.id).then(tip => {
          this.$confirm(tip + this.$t('project.delete_confirm'), this.$t('commons.prompt'), {
            confirmButtonText: this.$t('commons.confirm'),
            cancelButtonText: this.$t('commons.cancel'),
            type: 'warning'
          }).then(() => {
            this.$get('/project/delete/' + row.id, () => {
              Message.success(this.$t('commons.delete_success'));
              this.list();
            });
          }).catch(() => {
          });
        });
      },
      search() {
        this.list();
      },
      list() {
        let url = "/project/list/" + this.currentPage + '/' + this.pageSize;
        this.result = this.$post(url, this.condition, (response) => {
          let data = response.data;
          this.items = data.listObject;
          this.total = data.itemCount;
        })
      },
      getRelatedResource(projectId) {
        return new Promise((resolve, reject) => {
          this.$get('/project/related/resource/' + projectId, response => {
            let data = response.data;
            let result = '';
            result = this.appendDeleteTip(result, data.testCaseCount, this.$t('test_track.case.test_case'));
            result = this.appendDeleteTip(result, data.testPlanCount, this.$t('test_track.plan.test_plan') );
            result = this.appendDeleteTip(result, data.loadTestCount, this.$t('commons.performance'));
            result = this.appendDeleteTip(result, data.apiTestCount, this.$t('commons.api'));
            if (result != '') {
              result = this.$t('project.delete_tip') + result;
            }
            resolve(result);
          });
        });
      },
      appendDeleteTip(result, count, tip) {
        if (count > 0) {
          return result + count + "ä¸ª" + tip + ',';
        } else {
          return result;
        }
      },
      link(row) {
        // performance_test project link
        if (this.$route.name === 'perProject') {
          this.$router.push({
            path: '/performance/test/' + row.id,
          })
        } else if (this.$route.name === 'fucProject') {
          this.$router.push({
            path: '/api/test/list/' + row.id
          })
        } else if (this.$route.name ==='trackProject') {
          this.$router.push({
            path: '/track/case/' + row.id
          })
        }
      },
      sort(column) {
        _sort(column, this.condition);
        this.list();
      },
    }
  }
</script>

<style scoped>

  .el-table {
    cursor:pointer;
  }

</style>
